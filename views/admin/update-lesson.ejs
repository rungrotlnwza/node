<%- include('../components/header/admin.header.ejs') %>

<div class="container-fluid p-3">
  <div class="row mb-4">
    <div class="col-12 text-center text-md-start">
      <h1 class="fw-bold mb-1">แก้ไขบทเรียน</h1>
      <p class="text-light mb-0">ดึงข้อมูลจาก API /api/lesson/:id และเติมลงฟอร์ม</p>
    </div>
  </div>

  <form id="lesson-form" class="row g-4">
    <!-- Left: Basic info -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="fw-bold mb-3">ข้อมูลบทเรียน</h5>

          <div class="mb-3">
            <label for="lesson_name" class="form-label">ชื่อบทเรียน</label>
            <input id="lesson_name" type="text" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="lesson_category" class="form-label">หมวดหมู่</label>
            <select class="form-select" id="lesson_category" required>
              <option value="">-- เลือกหมวดหมู่ --</option>
              <option value="reading">Reading</option>
              <option value="listening">Listening</option>
              <option value="grammar">Grammar</option>
              <option value="writing">Writing</option>
              <option value="speaking">Speaking</option>
              <option value="vocabulary">Vocabulary</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="lesson_level" class="form-label">ระดับ</label>
            <select class="form-select" id="lesson_level" required>
              <option value="">-- เลือกระดับ --</option>
              <option value="A1">A1</option>
              <option value="A2">A2</option>
              <option value="B1">B1</option>
              <option value="B2">B2</option>
              <option value="C1">C1</option>
              <option value="C2">C2</option>
            </select>
          </div>

          <div class="mb-0">
            <label class="form-label d-block">สถานะ</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="status" id="status_open" value="open">
              <label class="form-check-label" for="status_open">เปิด</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="status" id="status_close" value="close">
              <label class="form-check-label" for="status_close">ปิด</label>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Right: Content -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">เนื้อหาบทเรียน</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" id="add-paragraph-btn">+ เพิ่มเนื้อหา</button>
          </div>
          <div id="lesson-content-list" class="d-flex flex-column gap-3"></div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="col-12">
      <div class="d-flex justify-content-end gap-2">
        <a href="/admin/lesson" class="btn btn-outline-secondary">ยกเลิก</a>
        <button type="button" class="btn btn-primary" id="save-btn">บันทึก</button>
      </div>
    </div>
  </form>
  <template id="content-type-template">
    <div class="border p-3 rounded mb-3 position-relative bg-white shadow-sm content-block">
      <label class="form-label fw-bold">ประเภทเนื้อหา</label>
      <select class="form-select content-type-select mb-2">
        <option value="">-- เลือกประเภท --</option>
        <option value="text">ข้อความ (Text)</option>
        <option value="image">รูปภาพ (Image)</option>
        <option value="pdf">ไฟล์ PDF</option>
      </select>
      <div class="content-editor"></div>
      <button type="button" class="btn btn-danger btn-sm remove-content position-absolute top-0 end-0 m-2">ลบ</button>
    </div>
  </template>

  <template id="text-content-template">
    <textarea class="form-control content-text" rows="3" placeholder="กรอกเนื้อหา..."></textarea>
  </template>

  <template id="image-content-template">
    <div class="preview-area mb-2"></div>
    <input type="file" class="form-control content-image" accept="image/*">
  </template>

  <template id="pdf-content-template">
    <div class="preview-area mb-2"></div>
    <input type="file" class="form-control content-pdf" accept="application/pdf">
  </template>

  <script>
    const list = document.getElementById('lesson-content-list');
    const addBtn = document.getElementById('add-paragraph-btn');
    const urlParams = new URLSearchParams(window.location.search);
    const lessonId = urlParams.get('id');

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // ฟังก์ชันสร้าง Block เนื้อหา
    function renderBlock(type = '', value = '', fileUrl = '') {
      const typeTemplate = document.getElementById('content-type-template');
      const block = typeTemplate.content.cloneNode(true);
      const wrapper = block.querySelector('.content-block');
      const select = block.querySelector('.content-type-select');
      const editor = block.querySelector('.content-editor');

      select.addEventListener('change', () => updateEditor(editor, select.value));
      block.querySelector('.remove-content').addEventListener('click', () => wrapper.remove());

      if (type) {
        select.value = type === 'file' ? 'image' : type; // ปรับถ้า DB เก็บเป็น file
        updateEditor(editor, select.value, value, fileUrl);
      }
      list.appendChild(block);
    }

    function updateEditor(container, type, value = '', fileUrl = '') {
      container.innerHTML = '';
      const templateId = type === 'text' ? 'text-content-template' : (type === 'image' ? 'image-content-template' : 'pdf-content-template');
      const content = document.getElementById(templateId).content.cloneNode(true);

      if (type === 'text') {
        content.querySelector('.content-text').value = value;
      } else if (fileUrl) {
        const preview = content.querySelector('.preview-area');
        if (type === 'image') {
          preview.innerHTML = `<img src="${fileUrl}" class="img-thumbnail" style="max-height: 150px">`;
        } else {
          preview.innerHTML = `<a href="${fileUrl}" target="_blank" class="btn btn-sm btn-outline-info">เปิดดูไฟล์เดิม</a>`;
        }
      }
      container.appendChild(content);
    }

    // โหลดข้อมูล
    if (lessonId) {
      fetch(`/api/lesson/${lessonId}`, {
          headers: {
            'Authorization': 'Bearer ' + getCookie('token')
          }
        })
        .then(res => res.json())
        .then(data => {
          console.log(data)
          const l = data.lesson;
          document.getElementById('lesson_name').value = l.lesson_name;
          document.getElementById('lesson_category').value = l.lesson_category;
          document.getElementById('lesson_level').value = l.lesson_level;
          const statusRadio = document.querySelector(`input[name="status"][value="${l.status}"]`);
          if (statusRadio) statusRadio.checked = true;

          l.lesson_content.forEach(item => renderBlock(item.type === 'file' ? 'image' : item.type, item.value, item.url));
        });
    }

    addBtn.addEventListener('click', () => renderBlock());

    // บันทึก (บันทึก Index ให้ Backend ทำงานง่าย)
    document.getElementById('save-btn').addEventListener('click', async () => {
      const body = new FormData();
      body.append('lesson_name', document.getElementById('lesson_name').value);
      body.append('lesson_category', document.getElementById('lesson_category').value);
      body.append('lesson_level', document.getElementById('lesson_level').value);
      body.append('status', document.querySelector('input[name="status"]:checked').value);

      document.querySelectorAll('.content-block').forEach((block, i) => {
        const type = block.querySelector('.content-type-select').value;
        body.append(`lesson_content[${i}][type]`, type);
        if (type === 'text') {
          body.append(`lesson_content[${i}][value]`, block.querySelector('.content-text').value);
        } else {
          const file = block.querySelector('input[type="file"]').files[0];
          if (file) body.append(`lesson_content[${i}][file]`, file);
        }
      });

      const res = await fetch(`/api/update-lesson/${lessonId}`, {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + getCookie('token')
        },
        body
      });
      if (res.ok) alert('บันทึกสำเร็จ');
    });
  </script>