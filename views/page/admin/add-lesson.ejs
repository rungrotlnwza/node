<div class="container-fluid p-3">
  <!-- Page header -->
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="fw-bold mb-1">เพิ่มบทเรียนใหม่</h1>
      <p class="text-muted mb-0">จัดการเนื้อหาบทเรียน และหมวดหมู่</p>
    </div>
  </div>

  <!-- Form -->
  <form id="lesson-form" class="row g-4">

    <!-- Left: Basic info -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="fw-bold mb-3">ข้อมูลบทเรียน</h5>

          <!-- Lesson name -->
          <div class="mb-3">
            <label for="lesson_name" class="form-label">ชื่อบทเรียน</label>
            <input id="lesson_name" type="text" class="form-control" name="lesson_name" placeholder="เช่น AUTHOR’S PURPOSE" required>
          </div>

          <!-- Category -->
          <div class="mb-3">
            <label for="lesson_category" class="form-label">หมวดหมู่</label>
            <select class="form-select" id="lesson_category" name="lesson_category" required>
              <option value="">-- เลือกหมวดหมู่ --</option>
              <option value="reading">Reading</option>
              <option value="listening">Listening</option>
              <option value="grammar">Grammar</option>
              <option value="writing">Writing</option>
              <option value="speaking">Speaking</option>
              <option value="vocabulary">Vocabulary</option>
            </select>
          </div>

          <!-- Level -->
          <div class="mb-3">
            <label for="lesson_level" class="form-label">ระดับ</label>
            <select class="form-select" id="lesson_level" name="lesson_level" required>
              <option value="">-- เลือกระดับ --</option>
              <option value="A1">A1</option>
              <option value="A2">A2</option>
              <option value="B1">B1</option>
              <option value="B2">B2</option>
              <option value="C1">C1</option>
              <option value="C2">C2</option>
            </select>
          </div>

          <!-- Status -->
          <div class="mb-0">
            <label class="form-label d-block">สถานะบทเรียน</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="status" id="status_open" value="open" checked>
              <label class="form-check-label" for="status_open">เปิดใช้งาน</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="status" id="status_close" value="close">
              <label class="form-check-label" for="status_close">ปิดใช้งาน</label>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Right: Content -->
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">เนื้อหาบทเรียน</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" id="add-paragraph-btn">
              + เพิ่มเนื้อหา
            </button>
          </div>

          <!-- dynamic content -->
          <div id="lesson-content-list" class="d-flex flex-column gap-3"></div>
        </div>
      </div>
    </div>
    <template id="content-type-template">
      <div class="border rounded p-3 bg-light">
        <div class="mb-2">
          <label class="form-label">ประเภทเนื้อหา</label>
          <select class="form-select content-type-select">
            <option value="">-- เลือกประเภท --</option>
            <option value="text">ข้อความ</option>
            <option value="image">รูปภาพ</option>
            <option value="pdf">ไฟล์ PDF</option>
          </select>
        </div>

        <div class="content-editor"></div>

        <div class="text-end mt-2">
          <button type="button" class="btn btn-sm btn-outline-danger remove-content">
            ลบ
          </button>
        </div>
      </div>
    </template>
    <template id="text-content-template">
      <div>
        <label class="form-label">เนื้อหาข้อความ</label>
        <textarea class="form-control content-text" rows="4" placeholder="พิมพ์เนื้อหา..."></textarea>
      </div>
    </template>
    <template id="image-content-template">
      <div>
        <label class="form-label">อัปโหลดรูปภาพ</label>
        <input type="file" class="form-control content-image" accept="image/*">
      </div>
    </template>
    <template id="pdf-content-template">
      <div>
        <label class="form-label">อัปโหลดไฟล์ PDF</label>
        <input type="file" class="form-control content-pdf" accept="application/pdf">
      </div>
    </template>


    <!-- Actions -->
    <div class="col-12">
      <div class="d-flex justify-content-end gap-2">
        <a href="/admin/lesson" class="btn btn-outline-secondary">
          ยกเลิก
        </a>
        <button onclick="addlesson()" class="btn btn-primary">
          บันทึกบทเรียน
        </button>
      </div>
    </div>

  </form>
</div>
<script>
  const list = document.getElementById('lesson-content-list');
  const addBtn = document.getElementById('add-paragraph-btn');

  const typeTemplate = document.getElementById('content-type-template');
  const textTemplate = document.getElementById('text-content-template');
  const imageTemplate = document.getElementById('image-content-template');
  const pdfTemplate = document.getElementById('pdf-content-template');

  addBtn.addEventListener('click', () => {
    const block = typeTemplate.content.cloneNode(true);
    const wrapper = block.querySelector('.border');

    const select = block.querySelector('.content-type-select');
    const editor = block.querySelector('.content-editor');
    const removeBtn = block.querySelector('.remove-content');

    select.addEventListener('change', () => {
      editor.innerHTML = '';

      let content;
      switch (select.value) {
        case 'text':
          content = textTemplate.content.cloneNode(true);
          break;
        case 'image':
          content = imageTemplate.content.cloneNode(true);
          break;
        case 'pdf':
          content = pdfTemplate.content.cloneNode(true);
          break;
        default:
          return;
      }

      editor.appendChild(content);
    });

    removeBtn.addEventListener('click', () => {
      wrapper.remove();
    });

    list.appendChild(block);
  });

  function addlesson() {
    // -----------------------------
    // 0) ตรวจสอบค่าหลักก่อน
    // -----------------------------
    const lessonName = document.getElementById('lesson_name').value.trim();
    const lessonCategory = document.getElementById('lesson_category').value;
    const lessonLevel = document.getElementById('lesson_level').value;
    const status = document.querySelector('input[name="status"]:checked').value;

    if (!lessonName) {
      alert('กรุณากรอกชื่อบทเรียน');
      return;
    }
    if (!lessonCategory) {
      alert('กรุณาเลือกหมวดหมู่');
      return;
    }
    if (!lessonLevel) {
      alert('กรุณาเลือกระดับ');
      return;
    }

    // -----------------------------
    // 1) build lesson_content
    // -----------------------------
    const lesson_content = [];

    document.querySelectorAll('#lesson-content-list > .border')
      .forEach(block => {
        const type = block.querySelector('.content-type-select').value;
        if (!type) return;

        if (type === 'text') {
          const value = block.querySelector('.content-text').value.trim();
          if (value) {
            lesson_content.push({
              type: 'text',
              value
            });
          }
        } else if (type === 'image') {
          const file = block.querySelector('.content-image').files[0];
          if (file) {
            lesson_content.push({
              type: 'image',
              file
            });
          }
        } else if (type === 'pdf') {
          const file = block.querySelector('.content-pdf').files[0];
          if (file) {
            lesson_content.push({
              type: 'pdf',
              file
            });
          }
        }
      });

    if (lesson_content.length === 0) {
      alert('กรุณาเพิ่มเนื้อหาบทเรียนอย่างน้อย 1 บล็อก');
      return;
    }

    // -----------------------------
    // 2) build FormData
    // -----------------------------
    const body = new FormData();
    body.append('lesson_name', lessonName);
    body.append('lesson_category', lessonCategory);
    body.append('lesson_level', lessonLevel);
    body.append('status', status);

    lesson_content.forEach((c, i) => {
      body.append(`lesson_content[${i}][type]`, c.type);
      if (c.type === 'text') {
        body.append(`lesson_content[${i}][value]`, c.value);
      } else if (c.file) {
        body.append(`lesson_content[${i}][file]`, c.file);
      }
    });

    // -----------------------------
    // 3) fetch
    // -----------------------------
    fetch('/api/add-lesson', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${getCookie('token')}`
        },
        body
      })
      .then(res => res.json())
      .then(data => {
        console.log('SUCCESS:', data);
      })
      .catch(err => {
        console.error('ERROR:', err);
      });
  }
</script>