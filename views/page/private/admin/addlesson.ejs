<style>
  body {
    background-color: #f0f2f5;
  }

  .paper-container {
    min-height: 297mm;
    padding: 20mm;
    margin: 20px auto;
    background-color: white !important;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    outline: none;
  }

  .code-mode {
    background-color: #1e1e1e !important;
    color: #d4d4d4;
    font-family: Consolas, monospace;
  }
</style>
<div class="mb-3">
  <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
  <input type="text" id="lesson_name" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." required>
</div>

<div class="row mb-3">
  <div class="col-md-4">
    <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
    <select id="lesson_category" class="form-select">
      <option value="reading">Reading</option>
      <option value="listening">Listening</option>
      <option value="grammar">Grammar</option>
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">‡∏£‡∏∞‡∏î‡∏±‡∏ö (Level)</label>
    <select id="lesson_level" class="form-select">
      <option value="A1">A1</option>
      <option value="A2">A2</option>
      <option value="B1">B1</option>
      <option value="B2">B2</option>
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
    <select id="lesson_status" class="form-select">
      <option value="open">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
      <option value="close">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
    </select>
  </div>
</div>
<!-- Toolbar -->
<div id="menu" class="container p-2 d-flex gap-2 bg-dark">
  <button class="btn btn-sm btn-outline-light" onclick="formatDoc('bold')" title="‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤">
    <i class="fa-solid fa-bold"></i>
  </button>
  <button class="btn btn-sm btn-outline-light" onclick="formatDoc('italic')" title="‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏µ‡∏¢‡∏á">
    <i class="fa-solid fa-italic"></i>
  </button>
  <button class="btn btn-sm btn-outline-light" onclick="toggleCodeMode()" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Code">
    <i class="fa-solid fa-code"></i>
  </button>
  <button class="btn btn-sm btn-outline-light" onclick="triggerImageInput()" title="‡πÅ‡∏ó‡∏£‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
    <i class="fa-solid fa-image"></i>
  </button>
  <button type="button" onclick="handleMediaClick('video')" title="‡πÉ‡∏™‡πà‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠">üìπ</button>
  <button type="button" onclick="handleMediaClick('audio')" title="‡πÉ‡∏™‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á">üéµ</button>
  <input type="file" id="imageInput" accept="image/*" hidden onchange="insertImage(this)" />
</div>

<!-- Editor -->
<div id="editor" class="paper-container text-dark" contenteditable="true">
  <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...</p>
</div>

<!-- Controls -->
<div style="margin:20px">
  <button onclick="log()">Log HTML</button>
  <button onclick="syncToMonaco()">Sync to Monaco</button>
</div>

<!-- Monaco -->
<div id="container" style="height:400px;"></div>
<button type="button" class="btn btn-sm btn-success ms-auto" onclick="saveLesson()" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£">
  <i class="fa-solid fa-floppy-disk"></i> Save
</button>
<script>
  /* ---------- Editor Logic ---------- */

  function formatDoc(cmd, value = null) {
    document.execCommand(cmd, false, value);
  }

  function toggleCodeMode() {
    document.getElementById('editor').classList.toggle('code-mode');
  }

  function triggerImageInput() {
    document.getElementById('imageInput').click();
  }
  const mediaBlobMap = {}; // filename -> blobUrl
  const pendingFiles = []; // File objects to be uploaded with the lesson

  function handleMediaClick(type) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = type === 'video' ? 'video/*' : 'audio/*';

    input.onchange = () => {
      const file = input.files[0];
      if (!file) return;

      const blobUrl = URL.createObjectURL(file);
      mediaBlobMap[file.name] = blobUrl;

      const html =
        type === 'video' ?
        `
          <video
            src="${blobUrl}"
            data-filename="${file.name}"
            controls
            style="max-width:100%; display:block; margin:10px 0;"
          ></video>
        ` :
        `
          <audio
            src="${blobUrl}"
            data-filename="${file.name}"
            controls
            style="display:block; margin:10px 0;"
          ></audio>
        `;

      document.execCommand('insertHTML', false, html);
      // remember file for upload
      pendingFiles.push(file);
      input.value = '';
    };

    input.click();
  }

  function insertImage(input) {
    if (!input.files || !input.files[0]) return;

    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = e => {
      const imgHTML = `
      <img
        src="${e.target.result}"
        data-filename="${file.name}"
        style="max-width:100%; display:block; margin:10px 0;"
      />
    `;
      document.execCommand('insertHTML', false, imgHTML);
      // remember file for upload
      pendingFiles.push(file);
      input.value = '';
    };

    reader.readAsDataURL(file);
  }

  /* ---------- Document Source ---------- */

  function getDocumentHTMLForMonaco() {
    const clone = document.getElementById('editor').cloneNode(true);

    clone.querySelectorAll('img, video, audio').forEach(el => {
      const filename = el.getAttribute('data-filename');
      if (filename) {
        el.setAttribute('src', filename);
      }
    });

    return clone.innerHTML.trim();
  }


  function getDocumentHTML() {
    return document.getElementById('editor').innerHTML.trim();
  }

  function log() {
    console.log(getDocumentHTML());
  }


  require.config({
    paths: {
      vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs'
    }
  });

  let monacoEditor;

  require(['vs/editor/editor.main'], function() {
    monacoEditor = monaco.editor.create(
      document.getElementById('container'), {
        value: getDocumentHTML(),
        language: 'html',
        theme: 'vs-dark',
        automaticLayout: true
      }
    );
  });

  async function syncToMonaco() {
    if (!monacoEditor) return;

    const rawHTML = getDocumentHTMLForMonaco();

    try {
      // ‡πÉ‡∏ä‡πâ Prettier format (‡∏ã‡∏∂‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
      // prettier.format ‡πÄ‡∏õ‡πá‡∏ô async function ‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 3.x
      const formattedHTML = await prettier.format(rawHTML, {
        parser: "html",
        plugins: prettierPlugins,
        printWidth: 80,
        tabWidth: 2,
      });

      monacoEditor.setValue(formattedHTML);
    } catch (error) {
      console.error("Formatting error:", error);
      // ‡∏ñ‡πâ‡∏≤ format ‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏î‡∏¥‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô
      monacoEditor.setValue(rawHTML);
    }
  }

  function revokeAllMediaBlobs() {
    Object.values(mediaBlobMap).forEach(url => {
      try {
        URL.revokeObjectURL(url);
      } catch (_) {}
    });
  }
  revokeAllMediaBlobs()

  async function saveLesson() {
    const formData = new FormData();

    // 1. ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Text fields ‡∏•‡∏á‡πÉ‡∏ô formData
    formData.append('lesson_name', document.getElementById('lesson_name').value);
    formData.append('lesson_category', document.getElementById('lesson_category').value);
    formData.append('lesson_level', document.getElementById('lesson_level').value);
    formData.append('lesson_status', document.getElementById('lesson_status').value);
    formData.append('lesson_content', getDocumentHTMLForMonaco());

    // 2. ‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡πÉ‡∏ô formData
    pendingFiles.forEach(file => {
      formData.append('media', file);
    });

    // ‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ promise chain ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ parsed JSON (axios-like: then(res => res.data))
    fetch('/api/lesson', {
        method: 'POST',
        headers: {
          // ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á Content-Type ‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ FormData ‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Browser ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Boundary ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
          'Authorization': `Bearer ${getCookie('token')}`
        },
        body: formData // ‡∏™‡πà‡∏á formData ‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Ñ‡∏£‡∏±‡∏ö
      })
      .then(async res => {
        const data = await res.json().catch(() => null);
        if (!res.ok) {
          console.error('API error:', data);
          const detail = data && data.detail ? `\nDetail: ${JSON.stringify(data.detail)}` : '';
          const message = data && data.message ? data.message : 'Server error';
          throw new Error(message + detail);
        }
        return data; // resolved value is like `response.data`
      })
      .then(data => {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      })
      .catch(err => {
        console.error('SaveLesson failed:', err);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err && err.message ? err.message : '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
        console.log('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err && err.message ? err.message : '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      });
  }
</script>

<!-- ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ -->
<!-- ‡∏õ‡∏£‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏¢‡∏π‡πà ‡πÇ‡∏î‡∏¢‡∏°‡∏≤‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô json ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏ü‡∏•‡∏∑‡∏î‡πâ‡∏ß‡∏¢‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô fromdata -->
<!-- ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏∏‡πà‡∏á‡πÇ‡∏£‡∏à‡∏ô‡πå -->