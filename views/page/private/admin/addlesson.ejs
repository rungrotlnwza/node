<style>
  .editor-wrapper {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  #editor-container {
    height: 450px;
  }

  .preview-window {
    border: 1px solid #ddd;
    min-height: 400px;
    background: white;
    border-radius: 5px;
  }

  #monaco-container {
    height: 400px;
    border: 1px solid #3c3c3c;
    border-radius: 5px;
    overflow: hidden;
  }

  .ql-editor img,
  .ql-editor video {
    max-width: 100%;
    height: auto;
    border-radius: 5px;
  }
</style>

<div class="row">
  <div class="col-lg-7">
    <div class="editor-wrapper p-4 mb-4">
      <h4 class="mb-4">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>

      <div class="mb-3">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
        <input type="text" id="lesson_name" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...">
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
          <select id="lesson_category" class="form-select">
            <option value="reading">Reading</option>
            <option value="listening">Listening</option>
            <option value="grammar">Grammar</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">‡∏£‡∏∞‡∏î‡∏±‡∏ö (Level)</label>
          <select id="lesson_level" class="form-select">
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="B1">B1</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select id="lesson_status" class="form-select">
            <option value="open">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
            <option value="close">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <div id="toolbar-container">
          <span class="ql-formats">
            <button class="ql-bold"></button>
            <button class="ql-italic"></button>
            <button class="ql-underline"></button>
          </span>
          <span class="ql-formats">
            <button class="ql-image" title="‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"></button>
            <button type="button" onclick="handleMediaClick('video')" title="‡πÉ‡∏™‡πà‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠">üìπ</button>
            <button type="button" onclick="handleMediaClick('audio')" title="‡πÉ‡∏™‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á">üéµ</button>
            <button type="button" onclick="handleFileClick()" title="‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£">üìÑ</button>
          </span>
        </div>
        <div id="editor-container"></div>
      </div>

      <div class="text-end">
        <button class="btn btn-outline-dark" onclick="processAndPreview()">üîç ‡∏î‡∏π Code HTML ‡πÅ‡∏•‡∏∞ Preview</button>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-sm sticky-top" style="top: 20px;">
      <div class="card-header bg-primary text-white">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå Preview</div>
      <div class="card-body">
        <div id="final-preview" class="preview-window p-3 mb-3">
          <p class="text-muted">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π Preview ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>

        <div class="mb-3">
          <label class="form-label font-weight-bold">HTML Code (‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡πâ‡∏ß)</label>
          <div id="monaco-container"></div>
        </div>

        <button class="btn btn-success w-100 py-3" onclick="saveLesson()">
          üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á Database
        </button>
        <div id="upload-status" class="text-center mt-2 small text-muted"></div>
      </div>
    </div>
  </div>
</div>

<script>
  Quill.debug(false);
  // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Multimedia Blots ---
  let BlockEmbed = Quill.import('blots/block/embed');
  class VideoBlot extends BlockEmbed {
    static create(value) {
      let node = super.create();
      node.setAttribute('src', value.url);
      node.setAttribute('data-filename', value.filename);
      node.setAttribute('controls', '');
      node.setAttribute('class', 'w-100 my-2');
      return node;
    }
    static value(node) {
      return {
        url: node.getAttribute('src'),
        filename: node.getAttribute('data-filename')
      };
    }
  }
  VideoBlot.blotName = 'video';
  VideoBlot.tagName = 'video';
  Quill.register(VideoBlot);

  class AudioBlot extends BlockEmbed {
    static create(value) {
      let node = super.create();
      node.setAttribute('src', value.url);
      node.setAttribute('data-filename', value.filename);
      node.setAttribute('controls', '');
      node.setAttribute('class', 'w-100 my-2');
      return node;
    }
    static value(node) {
      return {
        url: node.getAttribute('src'),
        filename: node.getAttribute('data-filename')
      };
    }
  }
  AudioBlot.blotName = 'audio';
  AudioBlot.tagName = 'audio';
  Quill.register(AudioBlot);

  // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Quill ---
  var quill = new Quill('#editor-container', {
    modules: {
      toolbar: '#toolbar-container'
    },
    theme: 'snow'
  });

  let pendingFiles = [];
  var blobMap = {};

  // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Monaco ---
  var monacoEditor;
  (function() {
    const _monacoBase = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs';

    function createEditor() {
      if (monacoEditor) return;
      monacoEditor = monaco.editor.create(document.getElementById('monaco-container'), {
        value: "",
        language: 'html',
        theme: 'vs-dark',
        automaticLayout: true,
        minimap: {
          enabled: false
        }
      });
    }

    function initMonaco() {
      if (typeof require === 'undefined' || !require.config) return;
      try {
        require.config({
          paths: {
            vs: _monacoBase
          }
        });
        if (require.defined && require.defined('vs/editor/editor.main')) {
          createEditor();
        } else {
          require(['vs/editor/editor.main'], function() {
            createEditor();
          });
        }
      } catch (e) {
        console.error('Monaco init error:', e);
      }
    }

    if (typeof window.require === 'undefined' || !window.require.config) {
      var s = document.createElement('script');
      s.src = _monacoBase + '/loader.min.js';
      s.onload = initMonaco;
      s.onerror = function() {
        console.error('Failed to load Monaco loader.');
      };
      document.head.appendChild(s);
    } else {
      initMonaco();
    }
  })();

  // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏±‡∏•‡∏ï‡∏¥‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢ ---
  function handleMediaClick(type) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = type === 'video' ? 'video/*' : 'audio/*';
    input.onchange = () => {
      const file = input.files[0];
      const range = quill.getSelection(true);
      const blobUrl = URL.createObjectURL(file);
      blobMap[file.name] = blobUrl;
      quill.insertEmbed(range.index, type, {
        url: blobUrl,
        filename: file.name
      });
      pendingFiles.push(file);
      // Ensure any inserted media gets proper classes
      try {
        addImgClassesToEditor();
      } catch (err) {}
    };
    input.click();
  }

  function handleFileClick() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '*/*';
    input.onchange = () => {
      const file = input.files[0];
      const range = quill.getSelection(true) || {
        index: 0
      };
      const blobUrl = URL.createObjectURL(file);
      blobMap[file.name] = blobUrl;
      const lower = (file.type || '').toLowerCase();
      let html = '';
      if (lower === 'application/pdf') {
        // Insert an anchor/placeholder into Quill (Quill may strip iframes),
        // preview rendering will convert this to an iframe using blobMap.
        html = `<a href="${blobUrl}" data-filename="${file.name}" class="file-link" target="_blank">${file.name}</a>`;
      } else if (lower.startsWith('image/')) {
        html = `<img src="${blobUrl}" data-filename="${file.name}" class="img-fluid rounded my-2">`;
      } else if (lower.startsWith('video/')) {
        html = `<video src="${blobUrl}" data-filename="${file.name}" controls class="w-100 my-2"></video>`;
      } else if (lower.startsWith('audio/')) {
        html = `<audio src="${blobUrl}" data-filename="${file.name}" controls class="w-100 my-2"></audio>`;
      } else {
        // Unknown file type: insert download link
        html = `<a href="${blobUrl}" data-filename="${file.name}" target="_blank">${file.name}</a>`;
      }
      quill.clipboard.dangerouslyPasteHTML(range.index, html);
      pendingFiles.push(file);
      try {
        addImgClassesToEditor();
      } catch (err) {
        console.error(err);
      }
    };
    input.click();
  }

  quill.getModule('toolbar').addHandler('image', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = () => {
      const file = input.files[0];
      const range = quill.getSelection(true);
      const blobUrl = URL.createObjectURL(file);
      blobMap[file.name] = blobUrl;
      const html = `<img src="${blobUrl}" data-filename="${file.name}" class="img-fluid rounded my-2">`;
      quill.clipboard.dangerouslyPasteHTML(range.index, html);
      pendingFiles.push(file);
      try {
        addImgClassesToEditor();
      } catch (err) {
        console.error(err);
      }
    };
    input.click();
  });

  // Ensure pasted/inserted media elements receive expected classes
  function addImgClassesToEditor() {
    try {
      const imgs = quill.root.querySelectorAll('img');
      imgs.forEach(img => {
        const classes = new Set((img.getAttribute('class') || '').split(/\s+/).filter(Boolean));
        classes.add('img-fluid');
        classes.add('rounded');
        if (!classes.has('my-2')) classes.add('my-2');
        img.setAttribute('class', Array.from(classes).join(' '));
      });

      const videos = quill.root.querySelectorAll('video');
      videos.forEach(v => {
        const classes = new Set((v.getAttribute('class') || '').split(/\s+/).filter(Boolean));
        classes.add('w-100');
        if (!classes.has('my-2')) classes.add('my-2');
        v.setAttribute('class', Array.from(classes).join(' '));
      });

      const audios = quill.root.querySelectorAll('audio');
      audios.forEach(a => {
        const classes = new Set((a.getAttribute('class') || '').split(/\s+/).filter(Boolean));
        if (!classes.has('my-2')) classes.add('my-2');
        a.setAttribute('class', Array.from(classes).join(' '));
      });

      // ensure iframe/doc previews have sizing
      const iframes = quill.root.querySelectorAll('iframe');
      iframes.forEach(f => {
        const classes = new Set((f.getAttribute('class') || '').split(/\s+/).filter(Boolean));
        classes.add('w-100');
        if (!classes.has('my-2')) classes.add('my-2');
        f.setAttribute('class', Array.from(classes).join(' '));
        if (!f.style.height) f.style.height = '400px';
      });
    } catch (err) {
      console.error('addImgClassesToEditor error', err);
    }
  }

  quill.on('text-change', function() {
    addImgClassesToEditor();
  });

  // --- ‡∏£‡∏∞‡∏ö‡∏ö Preview ---
  function ensureMediaClasses(html) {
    try {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      wrapper.querySelectorAll('img').forEach(img => {
        const classes = new Set((img.getAttribute('class') || '').split(/\s+/).filter(Boolean));
        classes.add('img-fluid');
        classes.add('rounded');
        if (!classes.has('my-2')) classes.add('my-2');
        img.setAttribute('class', Array.from(classes).join(' '));
      });
      wrapper.querySelectorAll('video').forEach(v => {
        const classes = new Set((v.getAttribute('class') || '').split(/\s+/).filter(Boolean));
        classes.add('w-100');
        if (!classes.has('my-2')) classes.add('my-2');
        v.setAttribute('class', Array.from(classes).join(' '));
      });
      wrapper.querySelectorAll('audio').forEach(a => {
        const classes = new Set((a.getAttribute('class') || '').split(/\s+/).filter(Boolean));
        if (!classes.has('my-2')) classes.add('my-2');
        a.setAttribute('class', Array.from(classes).join(' '));
      });
      return wrapper.innerHTML;
    } catch (err) {
      console.error('ensureMediaClasses error', err);
      return html;
    }
  }

  function processAndPreview() {
    let content = quill.root.innerHTML;
    content = ensureMediaClasses(content);
    const displayHtml = buildPreviewHtml(content);
    document.getElementById('final-preview').innerHTML = `<div class="container-fluid">${displayHtml}</div>`;
    const codeContent = htmlWithFilenames(content);
    if (monacoEditor) {
      monacoEditor.setValue(codeContent);
      setTimeout(() => monacoEditor.getAction('editor.action.formatDocument').run(), 100);
    }
  }

  function buildPreviewHtml(html) {
    try {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      // For any element carrying data-filename, prefer blobMap['name'] for display
      wrapper.querySelectorAll('[data-filename]').forEach(el => {
        const fname = el.getAttribute('data-filename');
        const blobUrl = blobMap[fname];
        const tag = (el.tagName || '').toLowerCase();
        if (blobUrl) {
          if (tag === 'a') {
            // if PDF, show inline iframe, otherwise keep as link
            if (fname.toLowerCase().endsWith('.pdf')) {
              const iframe = document.createElement('iframe');
              iframe.src = blobUrl;
              iframe.setAttribute('data-filename', fname);
              iframe.className = (el.getAttribute('class') || '') + ' w-100 my-2';
              iframe.style.border = '0';
              iframe.style.height = '400px';
              el.parentNode.replaceChild(iframe, el);
            } else {
              el.setAttribute('href', blobUrl);
              el.setAttribute('target', '_blank');
            }
          } else {
            if (el.hasAttribute('src')) el.setAttribute('src', blobUrl);
          }
        }
      });
      return wrapper.innerHTML;
    } catch (err) {
      console.error('buildPreviewHtml error', err);
      return html;
    }
  }

  function htmlWithFilenames(html) {
    try {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      wrapper.querySelectorAll('[data-filename]').forEach(el => {
        const fname = (el.getAttribute('data-filename') || '').trim();
        if (!fname) return;
        const tag = (el.tagName || '').toLowerCase();
        if (tag === 'a') {
          // anchor: set href to filename (persisted path)
          el.setAttribute('href', fname);
        } else if (tag === 'img' || tag === 'video' || tag === 'audio' || tag === 'iframe') {
          el.setAttribute('src', fname);
        } else {
          // fallback: set href if possible
          try {
            el.setAttribute('href', fname);
          } catch (e) {}
        }
      });
      return wrapper.innerHTML;
    } catch (err) {
      console.error('htmlWithFilenames error', err);
      return html;
    }
  }

  // --- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà POST /api/lesson ---
  async function saveLesson() {
    const formData = new FormData();
    formData.append('lesson_name', document.getElementById('lesson_name').value);
    formData.append('lesson_category', document.getElementById('lesson_category').value);
    formData.append('lesson_level', document.getElementById('lesson_level').value);
    formData.append('lesson_status', document.getElementById('lesson_status').value);
    formData.append('lesson_content', htmlWithFilenames(ensureMediaClasses(quill.root.innerHTML)));

    pendingFiles.forEach(file => formData.append('media', file));

    document.getElementById('upload-status').innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

    try {
      const response = await fetch('/api/lesson', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${getCookie('token')}` // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á Token ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        },
        body: formData
      });

      const result = await response.json();
      if (response.ok) {
        alert('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + result.message);
        location.reload();
      } else {
        alert('‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
      }
    } catch (error) {
      console.error(error);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö');
    } finally {
      document.getElementById('upload-status').innerText = "";
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏∂‡∏á Cookie (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πá‡∏ö token ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô cookie)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
</script>