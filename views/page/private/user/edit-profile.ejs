<div class="container-fluid bg-dark mt-5">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card bg-dark border border-warning">
          <!-- Edit Header -->
          <div class="card-header bg-warning text-dark text-center">
            <h3 class="mb-1">
              <i class="fas fa-edit me-2"></i>แก้ไขข้อมูลส่วนตัว
            </h3>
            <p class="mb-0">อัปเดตข้อมูลส่วนตัวของคุณ</p>
          </div>
          <!-- Edit Form -->
          <div class="card-body p-4">
            <form id="editProfileForm" novalidate>
              <!-- Personal Information Section -->
              <div class="bg-secondary rounded p-3 mb-4">
                <h6 class="text-warning border-bottom border-warning pb-2 mb-3">
                  <i class="fas fa-user me-2"></i>ข้อมูลส่วนตัว
                </h6>
                <div class="row g-3">
                  <div class="col-12 col-md-6 col-lg-4">
                    <label for="firstName" class="form-label text-light">ชื่อ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control bg-dark text-light border-warning" id="firstName" name="firstName" required>
                    <div class="text-danger small" id="firstNameError"></div>
                  </div>
                  <div class="col-12 col-md-6 col-lg-4">
                    <label for="lastName" class="form-label text-light">นามสกุล <span class="text-danger">*</span></label>
                    <input type="text" class="form-control bg-dark text-light border-warning" id="lastName" name="lastName" required>
                    <div class="text-danger small" id="lastNameError"></div>
                  </div>
                  <div class="col-12 col-md-6 col-lg-4">
                    <label for="birthday" class="form-label text-light">วันเกิด</label>
                    <input type="date" class="form-control bg-dark text-light border-warning" id="birthday" name="birthday">
                    <div class="text-danger small" id="birthdayError"></div>
                  </div>
                  <div class="col-12 col-md-6 col-lg-4">
                    <label for="phone" class="form-label text-light">เบอร์โทรศัพท์</label>
                    <input type="tel" class="form-control bg-dark text-light border-warning" id="phone" name="phone" value="" required>
                    <div class="text-danger small" id="phoneError"></div>
                  </div>
                  <div class="col-12 col-md-6 col-lg-6">
                    <label for="email" class="form-label text-light">อีเมล</label>
                    <input type="email" class="form-control bg-dark text-light border-warning" id="email" name="email" required>
                    <div class="text-danger small" id="emailError"></div>
                  </div>
                  <div class="col-12 col-md-6 col-lg-6">
                    <label class="form-label text-light">ระดับการศึกษา</label>

                    <div class="row">
                      <div class="col-6">
                        <select class="form-select bg-dark text-light border-warning" id="education_level" name="education_level" required>
                          <option value="">ระดับการศึกษา</option>
                          <option value="primary">ประถมศึกษา</option>
                          <option value="secondary">มัธยมศึกษา</option>
                          <option value="vocational">ปวช./ปวส.</option>
                          <option value="bachelor">ปริญญาตรี</option>
                          <option value="master">ปริญญาโท</option>
                          <option value="doctor">ปริญญาเอก</option>
                        </select>
                      </div>

                      <div class="col-6">
                        <select class="form-select bg-dark text-light border-warning" id="education_status" name="education_status" required>
                          <option value="">สถานะ</option>
                          <option value="studying">กำลังศึกษา</option>
                          <option value="graduated">จบแล้ว</option>
                          <option value="dropped">ไม่ได้เรียนต่อ</option>
                        </select>
                      </div>
                    </div>
                    <div class="text-danger small" id="educationError"></div>
                  </div>
                  <div class="col-12">
                    <label class="form-label text-light">ที่อยู่ (จังหวัด)</label>

                    <div class="row g-2">
                      <!-- จังหวัด -->
                      <div class="col-12 col-md-4">
                        <select id="province_name" class="form-select bg-dark text-light border-warning" name="province_id" required>
                          <option value="">จังหวัด</option>
                        </select>
                      </div>

                      <!-- อำเภอ / เขต -->
                      <div class="col-12 col-md-4">
                        <select class="form-select bg-dark text-light border-warning" id="district" name="district_id" disabled required>
                          <option value="">อำเภอ / เขต</option>
                        </select>
                      </div>

                      <!-- ตำบล / แขวง -->
                      <div class="col-12 col-md-4">
                        <select class="form-select bg-dark text-light border-warning" id="subDistrict" name="sub_district_id" disabled required>
                          <option value="">ตำบล / แขวง</option>
                        </select>
                      </div>
                    </div>

                    <div class="text-danger small mt-1" id="addressError"></div>
                  </div>
                </div>
              </div>
            </form>
            <div class="d-flex justify-content-between mt-4">
              <a href="/user/me" class="btn btn-outline-warning">
                <i class="fas fa-times me-1"></i>ยกเลิก
              </a>
              <button onclick="update()" class="btn btn-warning">
                <i class="fas fa-save me-1"></i>บันทึกข้อมูล
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  let rawData = []; // เก็บข้อมูลที่อยู่จาก GitHub

  // --- 1. ฟังก์ชันหลักสำหรับเริ่มต้นระบบ ---
  async function initProfilePage() {
    try {
      // ขั้นตอนที่ 1: บอกให้ JavaScript "หยุดรอ" จนกว่าจะโหลดข้อมูลจังหวัดจาก GitHub เสร็จ
      const resGithub = await fetch('https://raw.githubusercontent.com/kongvut/thai-province-data/refs/heads/master/api/latest/province_with_district_and_sub_district.json');
      rawData = await resGithub.json();

      // วาดรายการจังหวัดลงใน Select รอไว้ก่อน
      renderProvinces(rawData);

      // ขั้นตอนที่ 2: บอกให้ "หยุดรอ" อีกครั้งเพื่อดึงข้อมูล User จาก API
      const resMe = await fetch('/api/me', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${getCookie('token')}`
        }
      });
      const userData = await resMe.json();

      // ขั้นตอนที่ 3: เมื่อข้อมูลทั้งสองอย่างพร้อมแล้ว ค่อยเริ่มฉีดข้อมูลลงในฟอร์ม
      fillUserData(userData);

    } catch (error) {
      console.error("Initialization failed:", error);
      // alert("ไม่สามารถโหลดข้อมูลได้ในขณะนี้ครับ");
    }
  }

  // --- 2. ฟังก์ชันฉีดข้อมูล User ลงในฟอร์ม ---
  function fillUserData(data) {
    // ข้อมูลทั่วไป
    document.getElementById("firstName").value = data.first_name || '';
    document.getElementById("lastName").value = data.last_name || '';
    document.getElementById("phone").value = data.phone || '';
    document.getElementById("email").value = data.email || '';
    document.getElementById("birthday").value = data.birth_date ? data.birth_date.split('T')[0] : '';
    document.getElementById("education_level").value = data.education_level || '';
    document.getElementById("education_status").value = data.education_status || '';

    // ข้อมูลที่อยู่ (จังหวัด -> อำเภอ -> ตำบล)
    if (data.province_name) {
      // เลือกจังหวัด
      const provinceSelect = document.getElementById('province_name');
      provinceSelect.value = data.province_name;

      // โหลดและเลือกอำเภอ
      renderDistricts(data.province_name, data.district_name);

      // โหลดและเลือกตำบล
      renderSubDistricts(data.province_name, data.district_name, data.sub_district_name);
    }
  }

  // --- 3. ฟังก์ชัน Render ต่างๆ ---

  function renderProvinces(data) {
    const provinceSelect = document.getElementById('province_name');
    provinceSelect.innerHTML = '<option value="">-- เลือกจังหวัด --</option>';
    data.forEach(p => {
      const opt = new Option(p.name_th, p.name_th);
      provinceSelect.add(opt);
    });
  }

  function renderDistricts(provinceName, selectedDistrictName = null) {
    const districtSelect = document.getElementById('district');
    const subDistrictSelect = document.getElementById('subDistrict');

    districtSelect.innerHTML = '<option value="">-- เลือกอำเภอ/เขต --</option>';
    subDistrictSelect.innerHTML = '<option value="">-- เลือกตำบล/แขวง --</option>';
    subDistrictSelect.disabled = true;

    if (!provinceName) {
      districtSelect.disabled = true;
      return;
    }

    const province = rawData.find(p => p.name_th === provinceName);
    if (province) {
      province.districts.forEach(d => {
        const opt = new Option(d.name_th, d.name_th);
        if (d.name_th === selectedDistrictName) opt.selected = true;
        districtSelect.add(opt);
      });
      districtSelect.disabled = false;
    }
  }

  function renderSubDistricts(provinceName, districtName, selectedSubName = null) {
    const subDistrictSelect = document.getElementById('subDistrict');
    subDistrictSelect.innerHTML = '<option value="">-- เลือกตำบล/แขวง --</option>';

    const province = rawData.find(p => p.name_th === provinceName);
    const district = province?.districts.find(d => d.name_th === districtName);

    if (district) {
      district.sub_districts.forEach(sd => {
        const opt = new Option(sd.name_th, sd.name_th);
        if (sd.name_th === selectedSubName) opt.selected = true;
        subDistrictSelect.add(opt);
      });
      subDistrictSelect.disabled = false;
    }
  }

  // --- 4. Event Listeners สำหรับการเปลี่ยนค่าหน้าจอ ---

  document.getElementById('province_name').addEventListener('change', function() {
    renderDistricts(this.value);
  });

  document.getElementById('district').addEventListener('change', function() {
    const pName = document.getElementById('province_name').value;
    renderSubDistricts(pName, this.value);
  });

  // --- 5. ฟังก์ชันส่งข้อมูลแก้ไข (Update) ---
  function update() {
    const bodyData = {
      first_name: document.getElementById("firstName").value,
      last_name: document.getElementById("lastName").value,
      phone: document.getElementById("phone").value,
      email: document.getElementById("email").value,
      birth_date: document.getElementById("birthday").value,
      education_level: document.getElementById("education_level").value,
      education_status: document.getElementById("education_status").value,
      province_name: document.getElementById("province_name").value,
      district_name: document.getElementById("district").value,
      sub_district_name: document.getElementById("subDistrict").value
    };

    fetch('/api/update', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getCookie('token')}`
        },
        body: JSON.stringify(bodyData)
      })
      .then(res => {
        if (!res.ok) throw new Error('update failed');
        return res.json();
      })
      .then(data => {
        deleteCookie('user');
        if (typeof updateCookieUser === 'function') updateCookieUser();
        location.reload();
      })
      .catch(err => {
        console.error(err);
        alert('ไม่สามารถบันทึกข้อมูลได้ครับ');
      });
  }

  // สั่งให้ระบบทำงานเมื่อโหลดหน้าเว็บ
  initProfilePage();
</script>