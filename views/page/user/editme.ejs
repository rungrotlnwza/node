<div class="container-fluid bg-dark mt-5">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card bg-dark border border-warning">
          <!-- Edit Header -->
          <div class="card-header bg-warning text-dark text-center">
            <h3 class="mb-1">
              <i class="fas fa-edit me-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
            </h3>
            <p class="mb-0">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
          </div>
          <!-- Edit Form -->
          <div class="card-body p-4">
            <form id="editProfileForm" novalidate>
              <!-- Personal Information Section -->
              <div class="bg-secondary rounded p-3 mb-4">
                <h6 class="text-warning border-bottom border-warning pb-2 mb-3">
                  <i class="fas fa-user me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
                </h6>
                <div class="row g-3">
                  <div class="col-12 col-md-6 col-lg-4">
                    <label for="firstName" class="form-label text-light">‡∏ä‡∏∑‡πà‡∏≠ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control bg-dark text-light border-warning" id="firstName" name="firstName" required>
                    <div class="text-danger small" id="firstNameError"></div>
                  </div>
                  <div class="col-12 col-md-6 col-lg-4">
                    <label for="lastName" class="form-label text-light">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="text-danger">*</span></label>
                    <input type="text" class="form-control bg-dark text-light border-warning" id="lastName" name="lastName" required>
                    <div class="text-danger small" id="lastNameError"></div>
                  </div>
                  <div class="col-12 col-md-6 col-lg-4">
                    <label for="birthday" class="form-label text-light">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
                    <input type="date" class="form-control bg-dark text-light border-warning" id="birthday" name="birthday">
                    <div class="text-danger small" id="birthdayError"></div>
                  </div>
                  <div class="col-12 col-md-6 col-lg-4">
                    <label for="phone" class="form-label text-light">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                    <input type="tel" class="form-control bg-dark text-light border-warning" id="phone" name="phone" value="" required>
                    <div class="text-danger small" id="phoneError"></div>
                  </div>
                  <div class="col-12 col-md-6 col-lg-6">
                    <label for="email" class="form-label text-light">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" class="form-control bg-dark text-light border-warning" id="email" name="email" required>
                    <div class="text-danger small" id="emailError"></div>
                  </div>
                  <div class="col-12 col-md-6 col-lg-6">
                    <label class="form-label text-light">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>

                    <div class="row">
                      <div class="col-6">
                        <select class="form-select bg-dark text-light border-warning" id="education_level" name="education_level" required>
                          <option value="">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                          <option value="primary">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                          <option value="secondary">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                          <option value="vocational">‡∏õ‡∏ß‡∏ä./‡∏õ‡∏ß‡∏™.</option>
                          <option value="bachelor">‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏ï‡∏£‡∏µ</option>
                          <option value="master">‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡πÇ‡∏ó</option>
                          <option value="doctor">‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡πÄ‡∏≠‡∏Å</option>
                        </select>
                      </div>

                      <div class="col-6">
                        <select class="form-select bg-dark text-light border-warning" id="education_status" name="education_status" required>
                          <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                          <option value="studying">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                          <option value="graduated">‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
                          <option value="dropped">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠</option>
                        </select>
                      </div>
                    </div>
                    <div class="text-danger small" id="educationError"></div>
                  </div>
                  <div class="col-12">
                    <label class="form-label text-light">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)</label>

                    <div class="row g-2">
                      <!-- ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î -->
                      <div class="col-12 col-md-4">
                        <select class="form-select bg-dark text-light border-warning" id="province" name="province_id" required>
                          <option value="">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                        </select>
                      </div>

                      <!-- ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡πÄ‡∏Ç‡∏ï -->
                      <div class="col-12 col-md-4">
                        <select class="form-select bg-dark text-light border-warning" id="district" name="district_id" disabled required>
                          <option value="">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡πÄ‡∏Ç‡∏ï</option>
                        </select>
                      </div>

                      <!-- ‡∏ï‡∏≥‡∏ö‡∏• / ‡πÅ‡∏Ç‡∏ß‡∏á -->
                      <div class="col-12 col-md-4">
                        <select class="form-select bg-dark text-light border-warning" id="subDistrict" name="sub_district_id" disabled required>
                          <option value="">‡∏ï‡∏≥‡∏ö‡∏• / ‡πÅ‡∏Ç‡∏ß‡∏á</option>
                        </select>
                      </div>
                    </div>

                    <div class="text-danger small mt-1" id="addressError"></div>
                  </div>
                </div>
              </div>
            </form>
            <div class="d-flex justify-content-between mt-4">
              <a href="/user/me" class="btn btn-outline-warning">
                <i class="fas fa-times me-1"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </a>
              <button onclick="update()" class="btn btn-warning">
                <i class="fas fa-save me-1"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    if (getCookie('user')) {
      const data = JSON.parse(getCookie('user'));
      document.getElementById("firstName").value = data.first_name || '-';
      document.getElementById("lastName").value = data.last_name || '-';
      document.getElementById("phone").value = data.phone || '-';
      document.getElementById("email").value = data.email || '-';
      document.getElementById("birthday").value = data.birth_date || '-';
      document.getElementById("education_level").value = data.education_level || '-';
      document.getElementById("education_status").value = data.education_status || '-';
    }
    let rawData = []; // ‡πÄ‡∏Å‡πá‡∏ö data ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    fetch('https://raw.githubusercontent.com/kongvut/thai-province-data/refs/heads/master/api/latest/province_with_district_and_sub_district.json')
      .then(res => res.json())
      .then(data => {
        rawData = data;
        renderProvinces(data);
      });

    function renderProvinces(data) {
      const provinceSelect = document.getElementById('province');
      provinceSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>';

      data.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name_th; // ‚úÖ ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠
        opt.textContent = p.name_th;
        provinceSelect.appendChild(opt);
      });
    }

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    document.getElementById('province').addEventListener('change', function() {
      const provinceName = this.value;
      const districtSelect = document.getElementById('district');
      const subDistrictSelect = document.getElementById('subDistrict');

      districtSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï --</option>';
      subDistrictSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á --</option>';
      subDistrictSelect.disabled = true;

      if (!provinceName) {
        districtSelect.disabled = true;
        return;
      }

      // ‚úÖ ‡∏´‡∏≤ province ‡∏î‡πâ‡∏ß‡∏¢ name_th
      const province = rawData.find(p => p.name_th === provinceName);
      if (!province) return;

      province.districts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.name_th; // ‚úÖ ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠
        opt.textContent = d.name_th;
        districtSelect.appendChild(opt);
      });

      districtSelect.disabled = false;
    });

    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï
    document.getElementById('district').addEventListener('change', function() {
      const districtName = this.value;
      const subDistrictSelect = document.getElementById('subDistrict');

      subDistrictSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á --</option>';

      if (!districtName) {
        subDistrictSelect.disabled = true;
        return;
      }

      const provinceName = document.getElementById('province').value;

      // ‚úÖ ‡∏´‡∏≤ province ‡∏î‡πâ‡∏ß‡∏¢ name_th
      const province = rawData.find(p => p.name_th === provinceName);
      if (!province) return;

      // ‚úÖ ‡∏´‡∏≤ district ‡∏î‡πâ‡∏ß‡∏¢ name_th
      const district = province.districts.find(d => d.name_th === districtName);
      if (!district) return;

      district.sub_districts.forEach(sd => {
        const opt = document.createElement('option');
        opt.value = sd.name_th; // ‚úÖ ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠
        opt.textContent = sd.name_th;
        subDistrictSelect.appendChild(opt);
      });

      subDistrictSelect.disabled = false;
    });

    function update() {
      fetch('/api/update', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getCookie('token')}`
          },
          body: JSON.stringify({
            first_name: firstName.value,
            last_name: lastName.value,
            phone: phone.value,
            email: email.value,
            birth_date: birthday.value,
            education_level: education_level.value,
            education_status: education_status.value,
            province_name: province.value,
            district_name: district.value,
            sub_district_name: subDistrict.value
          })
        })
        .then(res => {
          if (!res.ok) throw new Error('update failed');
          return res.json();
        })
        .then(data => {
          deleteCookie('user');
          // setCookie('user', JSON.stringify(data), 1);
          updateCookieUser();

          // üî• reload ‡∏´‡∏•‡∏±‡∏á set ‡πÄ‡∏™‡∏£‡πá‡∏à
          location.reload();
        })
        .catch(console.error);
    }
  </script>